name: Validate, Test & Deploy to RapidAPI

on:
  push:
    branches: [ main ]
    paths:
      - 'main.py'
      - 'ecomarine/**/*.py'
      - 'tests/**/*.py'
      - '.github/workflows/update-rapidapi-specs.yml'
      - 'scripts/extract_tests_for_rapidapi.py'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual update'

env:
  API_BASE_URL: http://localhost:8000
  MAX_RETRIES: 3
  RETRY_DELAY: 10

jobs:
  # =============================================================================
  # JOB 1: Validate Tests (Must Pass Before Deployment)
  # =============================================================================
  validate-tests:
    name: Validate Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-
      
      - name: Install dependencies
        run: |
          uv sync
          pip install pytest pytest-asyncio httpx
      
      - name: Run integration tests
        id: run_tests
        run: |
          echo "ğŸ§ª Running integration tests..."
          uv run pytest tests/integration/ -v --tb=short 2>&1 | tee test_output.log
          
          # Count tests
          test_count=$(grep -c "test_" tests/integration/test_api_integration.py || echo "0")
          passed_count=$(grep -c "PASSED" test_output.log || echo "0")
          failed_count=$(grep -c "FAILED" test_output.log || echo "0")
          
          echo "ğŸ“Š Test Results:"
          echo "   - Total test functions: $test_count"
          echo "   - Passed: $passed_count"
          echo "   - Failed: $failed_count"
          
          # Save results for next job
          echo "TEST_COUNT=$test_count" >> $GITHUB_ENV
          echo "PASSED_COUNT=$passed_count" >> $GITHUB_ENV
          echo "FAILED_COUNT=$failed_count" >> $GITHUB_ENV
          
          if [ "$failed_count" -gt 0 ]; then
            echo "âŒ Some tests failed! Blocking deployment."
            exit 1
          fi
          
          echo "âœ… All tests passed!"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_output.log
          retention-days: 30

  # =============================================================================
  # JOB 2: Extract & Generate Test Documentation
  # =============================================================================
  extract-tests:
    name: Extract Tests for RapidAPI
    runs-on: ubuntu-latest
    needs: validate-tests
    if: success()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Extract test cases
        id: extract
        run: |
          echo "ğŸ“‹ Extracting test cases from Python tests..."
          python scripts/extract_tests_for_rapidapi.py
          
          # Check output
          if [ -f ".rapidapi/tests/test_suite.json" ]; then
            test_count=$(python -c "import json; data=json.load(open('.rapidapi/tests/test_suite.json')); print(len(data['test_suite']['tests']))")
            echo "âœ… Extracted $test_count test cases"
            echo "EXTRACTED_COUNT=$test_count" >> $GITHUB_ENV
          else
            echo "âŒ Failed to generate test suite"
            exit 1
          fi
      
      - name: Display test summary
        run: |
          echo "ğŸ“„ Generated Test Files:"
          ls -lh .rapidapi/tests/
          
          echo ""
          echo "ğŸ“Š Test Summary:"
          cat .rapidapi/tests/summary.json | python -m json.tool
      
      - name: Upload test suite
        uses: actions/upload-artifact@v4
        with:
          name: rapidapi-test-suite
          path: .rapidapi/tests/
          retention-days: 30

  # =============================================================================
  # JOB 3: Deploy to RapidAPI (Only if validation passed)
  # =============================================================================
  deploy-rapidapi:
    name: Deploy to RapidAPI
    runs-on: ubuntu-latest
    needs: [validate-tests, extract-tests]
    if: success()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-
      
      - name: Install dependencies
        run: |
          uv sync
          pip install pyyaml
      
      - name: Download test suite
        uses: actions/download-artifact@v4
        with:
          name: rapidapi-test-suite
          path: .rapidapi/tests/
      
      - name: Start FastAPI server
        run: |
          echo "ğŸš€ Starting FastAPI server..."
          uv run uvicorn main:app --host 0.0.0.0 --port 8000 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server with timeout
          server_ready=false
          for i in {1..30}; do
            if curl -s http://localhost:8000/ > /dev/null; then
              echo "âœ… Server is ready!"
              server_ready=true
              break
            fi
            echo "â³ Waiting for server... ($i/30)"
            sleep 2
          done
          
          if [ "$server_ready" = false ]; then
            echo "âŒ Server failed to start"
            exit 1
          fi
      
      - name: Generate OpenAPI specs
        run: |
          echo "ğŸ“„ Generating OpenAPI specs..."
          
          # Retry logic for spec generation
          for attempt in {1..3}; do
            curl -s http://localhost:8000/openapi.json | python -m json.tool > openapi.json
            
            if [ -s openapi.json ] && [ $(wc -c < openapi.json) -gt 1000 ]; then
              echo "âœ… OpenAPI JSON generated (attempt $attempt)"
              echo "ğŸ“Š Size: $(wc -c < openapi.json) bytes"
              break
            fi
            
            echo "âš ï¸ Attempt $attempt failed, retrying..."
            sleep 5
          done
          
          if [ ! -s openapi.json ]; then
            echo "âŒ Failed to generate OpenAPI specs after 3 attempts"
            exit 1
          fi
          
          # Convert to YAML
          uv run python -c "
          import json
          import yaml
          with open('openapi.json', 'r') as f:
              data = json.load(f)
          with open('openapi.yaml', 'w') as f:
              yaml.dump(data, f, default_flow_style=False, sort_keys=False, allow_unicode=True)
          print('âœ… OpenAPI YAML generated')
          "
      
      - name: Deploy to RapidAPI with retry
        id: deploy
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_API_ID: ${{ secrets.RAPIDAPI_API_ID }}
          RAPIDAPI_VERSION_ID: ${{ secrets.RAPIDAPI_VERSION_ID }}
        run: |
          echo "ğŸš€ Deploying to RapidAPI..."
          echo "API ID: $RAPIDAPI_API_ID"
          echo "Version ID: $RAPIDAPI_VERSION_ID"
          
          # Retry logic for deployment
          max_attempts=3
          attempt=1
          success=false
          
          while [ $attempt -le $max_attempts ] && [ "$success" = false ]; do
            echo ""
            echo "ğŸ“¤ Deployment attempt $attempt/$max_attempts..."
            
            response=$(curl -s -w "\n%{http_code}" -X PUT \
              "https://platform.p.rapidapi.com/apis/${RAPIDAPI_API_ID}/versions/${RAPIDAPI_VERSION_ID}/spec" \
              -H "X-RapidAPI-Key: ${RAPIDAPI_KEY}" \
              -H "Content-Type: application/json" \
              -d @openapi.json 2>&1)
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            echo "HTTP Status: $http_code"
            
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ] || [ "$http_code" = "204" ]; then
              echo "âœ… RapidAPI deployment successful!"
              success=true
              echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
            else
              echo "âš ï¸ Deployment attempt $attempt failed (HTTP $http_code)"
              echo "Response: $body"
              
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ Waiting 10 seconds before retry..."
                sleep 10
              fi
              
              attempt=$((attempt + 1))
            fi
          done
          
          if [ "$success" = false ]; then
            echo "âŒ RapidAPI deployment failed after $max_attempts attempts"
            echo "DEPLOY_STATUS=failed" >> $GITHUB_ENV
            echo "DEPLOY_ERROR=$body" >> $GITHUB_ENV
            exit 1
          fi
      
      - name: Update test documentation on RapidAPI
        if: success()
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_API_ID: ${{ secrets.RAPIDAPI_API_ID }}
        run: |
          echo "ğŸ“š Updating test documentation..."
          
          # Read test documentation
          if [ -f ".rapidapi/tests/test_cases.md" ]; then
            test_docs=$(cat .rapidapi/tests/test_cases.md)
            
            # Note: RapidAPI doesn't have a direct API for updating docs via REST
            # This would typically be done through their GraphQL Platform API
            # For now, we generate the docs and they can be manually copied
            
            echo "âœ… Test documentation generated"
            echo "ğŸ“„ File: .rapidapi/tests/test_cases.md"
            echo "ğŸ“„ File: .rapidapi/tests/test_suite.json"
            
            # Create summary
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         RAPIDAPI DEPLOYMENT SUMMARY                    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âœ… OpenAPI Specs: Updated"
            echo "âœ… Test Cases: Extracted ($(cat .rapidapi/tests/summary.json | python -c "import sys,json; print(json.load(sys.stdin)['total_tests'])"))"
            echo "âœ… Documentation: Generated"
            echo ""
            echo "ğŸ“ Generated Files:"
            ls -lh .rapidapi/tests/
            echo ""
            echo "ğŸ”§ Manual Steps Required:"
            echo "   1. Copy test cases from .rapidapi/tests/test_cases.md to RapidAPI Docs tab"
            echo "   2. Import test_suite.json to RapidAPI Testing (if import feature available)"
            echo "   3. Use curl_commands.json for RapidAPI console examples"
          fi

  # =============================================================================
  # JOB 4: Notification (Success or Failure)
  # =============================================================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate-tests, extract-tests, deploy-rapidapi]
    if: always()
    
    steps:
      - name: Deployment Status Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         DEPLOYMENT PIPELINE SUMMARY                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Check validation status
          if [ "${{ needs.validate-tests.result }}" = "success" ]; then
            echo "âœ… Test Validation: PASSED"
          else
            echo "âŒ Test Validation: FAILED"
          fi
          
          # Check extraction status
          if [ "${{ needs.extract-tests.result }}" = "success" ]; then
            echo "âœ… Test Extraction: SUCCESS"
          else
            echo "âŒ Test Extraction: FAILED"
          fi
          
          # Check deployment status
          if [ "${{ needs.deploy-rapidapi.result }}" = "success" ]; then
            echo "âœ… RapidAPI Deployment: SUCCESS"
          else
            echo "âŒ RapidAPI Deployment: FAILED"
          fi
          
          echo ""
          echo "ğŸ“Š Overall Status: ${{ job.status }}"
          
          # Final verdict
          if [ "${{ needs.deploy-rapidapi.result }}" = "success" ]; then
            echo ""
            echo "ğŸ‰ SUCCESS! Your API is updated on RapidAPI!"
            echo "   - All 21 test cases validated"
            echo "   - Test documentation generated"
            echo "   - OpenAPI specs deployed"
          else
            echo ""
            echo "âš ï¸ WARNING: Deployment incomplete"
            echo "   Check the logs above for error details"
          fi

  # =============================================================================
  # JOB 5: Cleanup (Always runs)
  # =============================================================================
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-rapidapi]
    if: always()
    
    steps:
      - name: Cleanup processes
        run: |
          echo "ğŸ§¹ Cleaning up..."
          pkill -f "uvicorn" || true
          echo "âœ… Cleanup complete"
